*************************************************************************
*									*
*		DMA DISK CONTROLLER FIRMWARE				*
*									*
*************************************************************************

DATAPORT	EQU	0A0H
STATPORT	EQU	0A1H
INREADY		EQU	01H
OUTREADY	EQU	80H

DEST	EQU	80H

	ORG	100H
	JMP	RESTART

	ORG	200H
RESTART	IN	DATAPORT		;WILL THIS FIX FUNNY PROBLEM
	LXI	SP,STACK
	LXI	H,1000H ;STACK			;FIRST SOURCE ADDRESS
	LXI	B,8000H			;HOW MANY COUNTS TO RUN
LOOP	SHLD	SOURCE
	MOV	M,L
	MOV	A,H
	INX	H
	MOV	M,A
	DCX	H
	XCHG
	PUSH	B
	CALL	OUTLIST
	DB	L1END-$-1	;LENGTH
	DB	10H		;MOVMEM
	DW	DEST		;TO LO, HI
	DB	0FFH		;TO EX
SOURCE	DW	0000		;FROM LO, HI
	DB	0FFH		;FROM EX
	DB	1		;BLOCKS TO MOVE
	DB	16H		;GET GENERAL STATUS
L1END:
	POP	B
	CALL	INCHAR		;GET GEN STAT (WAIT FOR MOVE TO FINISH)

	LHLD	DEST
	XCHG
	MOV	A,H
	CMP	D
	JNZ	FAIL
	MOV	A,L
	CMP	E
	JNZ	FAIL
;
;	PASSED OK THIS ADDRESS
;
	INX	H		;NEXT ADDRESS
	DCX	B
	MOV	A,B
	ORA	C
	JNZ	LOOP		;IF MORE TO TEST
	MVI	A,' '
	OUT	23H		;SPACE TO INDICATE PASS
	JMP	RESTART
FAIL	MVI	A,'*'
	OUT	23H		;STAR SAYS TISK-TISK-tisk
	LHLD	SOURCE
	JMP	LOOP
	RST	7		;QUIT


OUTLIST:
	XTHL
	MOV	C,M
	INX	H
OUTLIST1:
	MOV	A,M
	INX	H
	CALL	OUTCHAR
	DCR	C
	JNZ	OUTLIST1
	XTHL
	RET

OUTCHAR:
	PUSH	PSW
OUTCHAR1:
	IN	STATPORT
	ANI	OUTREADY
	JNZ	OUTCHAR1
	POP	PSW
	OUT	DATAPORT
	RET
INCHAR:
	IN	STATPORT
	ANI	INREADY
	JZ	INCHAR
	IN	DATAPORT
	RET

	DS	100
STACK	DS	0

	END
